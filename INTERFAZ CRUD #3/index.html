<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CRUD Cifrado – WEB III</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <!-- DataTable -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

    <style>
        body {
            background: #f4f6f9;
            padding: 20px;
        }
        .card {
            border-radius: 10px;
        }
        .modal-content {
            border-radius: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card shadow p-4">
        <h3 class="text-center mb-4">CRUD de Categorías – WEB III API</h3>

        <button class="btn btn-primary mb-3" onclick="abrirModalAgregar()">Agregar Categoría</button>

        <table id="tablaCategorias" class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>



<!-- ===========================================================
   MODAL PARA AGREGAR/EDITAR
==============================================================-->
<div class="modal fade" id="modalCategoria" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tituloModal">Agregar Categoría</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="modo">
                <input type="hidden" id="categoriaId">

                <label>Nombre de la Categoría</label>
                <input type="text" id="nombre" class="form-control" placeholder="Ingrese el nombre de la categoría">
            </div>

            <div class="modal-footer">
                <button class="btn btn-warning" onclick="limpiar()">Limpiar</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-success" onclick="guardarCategoria()">Guardar</button>
            </div>
        </div>
    </div>
</div>



<!-- ===========================================================
   LIBRERÍAS JS
==============================================================-->
<!-- jQuery - SIEMPRE PRIMERO -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- DataTables - SIEMPRE DESPUÉS DE jQuery -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>



<!-- ===========================================================
   JAVASCRIPT PRINCIPAL
==============================================================-->
<script>
/* ===========================================================
   CONFIG DE LA API
===========================================================*/
const API_URL = "https://proyecto-i-web-iii-api-production.up.railway.app/controlador/categoria.php";


/* ===========================================================
   CARGAR TABLA
===========================================================*/
let tabla;

function cargarTabla() {
    fetch(API_URL, {
        method: "GET",
        mode: 'cors',
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.text();
    })
    .then(responseText => {
        console.log('Respuesta GET:', responseText);
        
        try {
            const data = JSON.parse(responseText);
            tabla.clear();
            
            // La API devuelve un array de objetos directamente
            if (Array.isArray(data)) {
                data.forEach(categoria => {
                    tabla.row.add([
                        categoria.id,
                        categoria.nombre,
                        `
                        <button class="btn btn-warning btn-sm" onclick="editar(${categoria.id}, '${categoria.nombre}')">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="eliminar(${categoria.id})">Eliminar</button>
                        `
                    ]);
                });
            }
            tabla.draw();
        } catch (jsonError) {
            console.error('Error parseando JSON:', jsonError);
            console.error('Respuesta recibida:', responseText);
            alert('Error: La API no devolvió JSON válido. Revisa la consola para más detalles.');
        }
    })
    .catch(error => {
        console.error('Error cargando categorías:', error);
        alert('Error cargando categorías: ' + error.message);
    });
}


/* ===========================================================
   ABRIR MODAL AGREGAR
===========================================================*/
function abrirModalAgregar() {
    $("#tituloModal").text("Agregar Categoría");
    $("#modo").val("agregar");

    $("#categoriaId").val("");
    $("#nombre").val("");

    new bootstrap.Modal("#modalCategoria").show();
}


/* ===========================================================
   EDITAR
===========================================================*/
function editar(id, nombre) {
    $("#tituloModal").text("Editar Categoría");
    $("#modo").val("editar");

    $("#categoriaId").val(id);
    $("#nombre").val(nombre);

    new bootstrap.Modal("#modalCategoria").show();
}


/* ===========================================================
   VERIFICAR SI EXISTE CATEGORÍA CON EL MISMO NOMBRE
===========================================================*/
function verificarNombreDuplicado(nombre, idActual = null) {
    return new Promise((resolve, reject) => {
        fetch(API_URL, {
            method: "GET",
            mode: 'cors',
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
        })
        .then(responseText => {
            try {
                const data = JSON.parse(responseText);
                
                if (Array.isArray(data)) {
                    // Buscar si existe una categoría con el mismo nombre
                    const categoriaExistente = data.find(categoria => 
                        categoria.nombre.toLowerCase() === nombre.toLowerCase() && 
                        categoria.id != idActual // Excluir la categoría que se está editando
                    );
                    
                    resolve(categoriaExistente ? true : false);
                } else {
                    resolve(false);
                }
            } catch (jsonError) {
                reject(new Error('Error parseando respuesta del servidor'));
            }
        })
        .catch(error => {
            reject(error);
        });
    });
}


/* ===========================================================
   GUARDAR (POST o PUT)
===========================================================*/
function guardarCategoria() {
    const modo = $("#modo").val();
    const nombre = $("#nombre").val().trim();
    
    if (!nombre) {
        alert("El nombre de la categoría es requerido");
        return;
    }

    // Verificar si el nombre ya existe
    const idActual = modo === "editar" ? $("#categoriaId").val() : null;
    
    verificarNombreDuplicado(nombre, idActual)
        .then(existe => {
            if (existe) {
                alert(` Ya existe una categoría con el nombre "${nombre}".\n\nPor favor, elije un nombre diferente.`);
                $("#nombre").focus();
                return;
            }
            
            // Si no existe, proceder con el guardado
            procederConGuardado(modo, nombre, idActual);
        })
        .catch(error => {
            console.error('Error verificando nombre duplicado:', error);
            alert('Error verificando nombre duplicado. Intentando guardar de todas formas...');
            procederConGuardado(modo, nombre, idActual);
        });
}


/* ===========================================================
   PROCEDER CON EL GUARDADO DESPUÉS DE VALIDACIÓN
===========================================================*/
function procederConGuardado(modo, nombre, idActual) {
    let url = API_URL;
    let metodo = "POST";
    let datos = { nombre: nombre };
    
    if (modo === "editar") {
        url = `${API_URL}?id=${idActual}`;
        metodo = "PUT";
        datos = { nombre: nombre };
    }

    fetch(url, {
        method: metodo,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(datos)
    })
    .then(response => response.json())
    .then(result => {
        alert(modo === "agregar" ? " Categoría creada exitosamente" : " Categoría actualizada exitosamente");
        cargarTabla();
        bootstrap.Modal.getInstance(document.querySelector("#modalCategoria")).hide();
    })
    .catch(error => {
        console.error('Error guardando categoría:', error);
        alert(' Error guardando categoría: ' + error.message);
    });
}


/* ===========================================================
   ELIMINAR
===========================================================*/
function eliminar(id) {
    if (!confirm("¿Está seguro de que desea eliminar esta categoría?")) return;

    // Usar el ID como parámetro en la URL para DELETE
    const url = `${API_URL}?id=${id}`;

    fetch(url, {
        method: "DELETE",
        mode: 'cors',
        headers: {
            'Accept': 'application/json'
        }
        // No enviar body en DELETE, usar solo el parámetro URL
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        // Primero obtener el texto de la respuesta
        return response.text();
    })
    .then(responseText => {
        console.log('Respuesta del servidor:', responseText);
        
        // Verificar si hay error de foreign key constraint
        if (responseText.includes('foreign key constraint fails') || 
            responseText.includes('Integrity constraint violation') ||
            responseText.includes('1451')) {
            alert(' No se puede eliminar esta categoría porque tiene productos asociados.\n\n' +
                  'Para eliminar esta categoría:\n' +
                  '1. Primero elimina todos los productos de esta categoría, o\n' +
                  '2. Cambia los productos a otra categoría');
            return;
        }
        
        // Verificar si la respuesta parece ser JSON
        try {
            const result = JSON.parse(responseText);
            alert(" Categoría eliminada exitosamente");
            cargarTabla();
        } catch (jsonError) {
            console.error('La respuesta no es JSON válido:', responseText);
            // Si la respuesta contiene "success" o algún indicador de éxito, asumir que funcionó
            if (responseText.toLowerCase().includes('success') || responseText.toLowerCase().includes('eliminad')) {
                alert(" Categoría eliminada exitosamente");
                cargarTabla();
            } else {
                alert(' Error del servidor:\n\n' + responseText.substring(0, 300));
            }
        }
    })
    .catch(error => {
        console.error('Error eliminando categoría:', error);
        alert(' Error eliminando categoría: ' + error.message);
    });
}

function limpiar() {
    $("#categoriaId").val("");
    $("#nombre").val("");
}


/* ===========================================================
   INICIALIZAR DATATABLE
===========================================================*/
$(document).ready(function () {
    tabla = $('#tablaCategorias').DataTable();
    cargarTabla();
});
</script>

</body>
</html>